"use strict";
/*
 * Copyright (c) 2018 by Filestack.
 * Some rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
var utils_1 = require("../utils");
// import { requestWithSource, request } from '../api/request';
var filestack_error_1 = require("./../../filestack_error");
var request_1 = require("../request");
/**
 * @private
 */
exports.PICKER_KEY = '__fs_picker_token';
/**
 * key for picker callback url (specifies which tab will be opened after opening picker)
 * @private
 */
exports.CALLBACK_URL_KEY = 'fs-tab';
/**
 * @private
 */
var CloudClient = /** @class */ (function () {
    function CloudClient(session, options) {
        /**
         * Returns flag if token should be cached in local storage
         *
         * @private
         * @type {boolean}
         * @memberof CloudClient
         */
        this.cache = false;
        /**
         * Flag for in-app browser setup
         * (in-app browsers are not supporting new window so we need to save token to session cache)
         *
         * @private
         * @memberof CloudClient
         */
        this._isInAppBrowser = false;
        this.session = session;
        this.cloudApiUrl = session.urls.cloudApiUrl;
        if (options && options.sessionCache) {
            this.cache = options.sessionCache;
        }
    }
    Object.defineProperty(CloudClient.prototype, "token", {
        get: function () {
            if (this.cache) {
                var token = localStorage.getItem(exports.PICKER_KEY);
                if (token)
                    return token;
            }
            if (this._isInAppBrowser) {
                return sessionStorage.getItem(exports.PICKER_KEY);
            }
            return this._token;
        },
        set: function (key) {
            if (this.cache) {
                localStorage.setItem(exports.PICKER_KEY, key);
            }
            if (this._isInAppBrowser) {
                sessionStorage.setItem(exports.PICKER_KEY, key);
            }
            this._token = key;
        },
        enumerable: true,
        configurable: true
    });
    CloudClient.prototype.prefetch = function () {
        var _this = this;
        var params = {
            apikey: this.session.apikey,
        };
        return request_1.FsRequest
            .get(this.cloudApiUrl + "/prefetch", { params: params })
            .then(function (res) { return res.data; })
            .then(function (data) {
            if (data.inapp_browser) {
                _this._isInAppBrowser = true;
            }
            return data;
        });
    };
    CloudClient.prototype.list = function (clouds, cancelTokenInput) {
        var _this = this;
        var payload = {
            apikey: this.session.apikey,
            clouds: clouds,
            flow: 'web',
            token: this.token,
        };
        if (this._isInAppBrowser) {
            payload.appurl = this.currentAppUrl();
        }
        if (this.session.policy && this.session.signature) {
            payload.policy = this.session.policy;
            payload.signature = this.session.signature;
        }
        var options = {};
        if (cancelTokenInput) {
            var cancelToken = new request_1.FsCancelToken();
            cancelTokenInput.cancel = cancelToken.cancel.bind(cancelToken);
            options.cancelToken = cancelToken;
        }
        return request_1.FsRequest
            .post(this.cloudApiUrl + "/folder/list", payload, options)
            .then(function (res) {
            if (res.data && res.data.token) {
                _this.token = res.data.token;
            }
            return res.data;
        });
    };
    CloudClient.prototype.store = function (name, path, options, customSource, cancelTokenInput) {
        var _a;
        var _this = this;
        if (options === void 0) { options = {}; }
        if (customSource === void 0) { customSource = {}; }
        // Default to S3
        if (options.location === undefined) {
            options.location = 's3';
        }
        var payload = {
            apikey: this.session.apikey,
            token: this.token,
            flow: 'web',
            clouds: (_a = {},
                _a[name] = {
                    path: path,
                    store: utils_1.removeEmpty(options),
                },
                _a),
        };
        if (name === 'customsource' && customSource.customSourcePath) {
            payload.clouds.customsource.customSourcePath = customSource.customSourcePath;
        }
        if (name === 'customsource' && customSource.customSourceContainer) {
            payload.clouds.customsource.customSourceContainer = customSource.customSourceContainer;
        }
        if (this.session.policy && this.session.signature) {
            payload.policy = this.session.policy;
            payload.signature = this.session.signature;
        }
        var requestOptions = {};
        if (cancelTokenInput) {
            var cancelToken = new request_1.FsCancelToken();
            cancelTokenInput.cancel = cancelToken.cancel.bind(cancelToken);
            requestOptions.cancelToken = cancelToken;
        }
        return request_1.FsRequest
            .post(this.cloudApiUrl + "/store/", payload, requestOptions)
            .then(function (res) {
            if (res.data && res.data.token) {
                _this.token = res.data.token;
            }
            if (res.data && res.data[name]) {
                return res.data[name];
            }
            return res.data;
        });
    };
    CloudClient.prototype.logout = function (name) {
        var _a;
        var payload = {
            apikey: this.session.apikey,
            flow: 'web',
            token: this.token,
        };
        if (name) {
            payload.clouds = (_a = {}, _a[name] = {}, _a);
        }
        else {
            if (this.cache) {
                // No name means logout of ALL clouds. Clear local session.
                localStorage.removeItem(exports.PICKER_KEY);
            }
            if (this._isInAppBrowser) {
                sessionStorage.removeItem(exports.PICKER_KEY);
            }
        }
        return request_1.FsRequest
            .post(this.cloudApiUrl + "/auth/logout", payload)
            .then(function (res) {
            if (res.data && res.data[name]) {
                return res.data[name];
            }
            return res.data;
        });
    };
    CloudClient.prototype.metadata = function (url) {
        var payload = {
            apikey: this.session.apikey,
            url: url,
        };
        if (this.session.policy && this.session.signature) {
            payload.policy = this.session.policy;
            payload.signature = this.session.signature;
        }
        return request_1.FsRequest
            .post(this.cloudApiUrl + "/metadata", payload)
            .then(function (res) { return res.data; });
    };
    // OpenTok API Endpoints
    CloudClient.prototype.tokInit = function (type) {
        if (type !== 'video' && type !== 'audio') {
            throw new filestack_error_1.FilestackError('Type must be one of video or audio.');
        }
        return request_1.FsRequest
            .post(this.cloudApiUrl + "/recording/" + type + "/init").then(function (res) { return res.data; });
    };
    CloudClient.prototype.tokStart = function (type, key, sessionId) {
        if (type !== 'video' && type !== 'audio') {
            throw new filestack_error_1.FilestackError('Type must be one of video or audio.');
        }
        var payload = {
            apikey: key,
            session_id: sessionId,
        };
        return request_1.FsRequest
            .post(this.cloudApiUrl + "/recording/" + type + "/start", payload)
            .then(function (res) { return res.data; });
    };
    CloudClient.prototype.tokStop = function (type, key, sessionId, archiveId) {
        if (type !== 'video' && type !== 'audio') {
            throw new filestack_error_1.FilestackError('Type must be one of video or audio.');
        }
        var payload = {
            apikey: key,
            session_id: sessionId,
            archive_id: archiveId,
        };
        return request_1.FsRequest
            .post(this.cloudApiUrl + "/recording/" + type + "/stop", payload)
            .then(function (res) { return res.data; });
    };
    CloudClient.prototype.currentAppUrl = function () {
        if (!window.URLSearchParams) {
            return undefined;
        }
        // set init string for clouds backend,
        // After this cloud service can make redirect back to current page url with selected tab for given cloud
        // if param exists and its value is init, backend will fill it with cloud name
        var searchParams = new URLSearchParams(window.location.search);
        searchParams.set(exports.CALLBACK_URL_KEY, 'init');
        return window.location.protocol + "//" + window.location.host + window.location.pathname + "?" + searchParams.toString();
    };
    return CloudClient;
}());
exports.CloudClient = CloudClient;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvYXBpL2Nsb3VkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7O0FBRUgsa0NBQXVDO0FBR3ZDLCtEQUErRDtBQUMvRCwyREFBeUQ7QUFDekQsc0NBQXNEO0FBRXREOztHQUVHO0FBQ1UsUUFBQSxVQUFVLEdBQUcsbUJBQW1CLENBQUM7QUFFOUM7OztHQUdHO0FBQ1UsUUFBQSxnQkFBZ0IsR0FBRyxRQUFRLENBQUM7QUFFekM7O0dBRUc7QUFDSDtJQStCRSxxQkFBWSxPQUFnQixFQUFFLE9BQXVCO1FBM0JyRDs7Ozs7O1dBTUc7UUFDSyxVQUFLLEdBQVksS0FBSyxDQUFDO1FBVy9COzs7Ozs7V0FNRztRQUNLLG9CQUFlLEdBQUcsS0FBSyxDQUFDO1FBRzlCLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxXQUFXLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUM7UUFFNUMsSUFBSSxPQUFPLElBQUksT0FBTyxDQUFDLFlBQVksRUFBRTtZQUNuQyxJQUFJLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUM7U0FDbkM7SUFDSCxDQUFDO0lBRUQsc0JBQUksOEJBQUs7YUFBVDtZQUNFLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtnQkFDZCxJQUFNLEtBQUssR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLGtCQUFVLENBQUMsQ0FBQztnQkFDL0MsSUFBSSxLQUFLO29CQUFFLE9BQU8sS0FBSyxDQUFDO2FBQ3pCO1lBRUQsSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFO2dCQUN4QixPQUFPLGNBQWMsQ0FBQyxPQUFPLENBQUMsa0JBQVUsQ0FBQyxDQUFDO2FBQzNDO1lBRUQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQ3JCLENBQUM7YUFFRCxVQUFVLEdBQUc7WUFDWCxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7Z0JBQ2QsWUFBWSxDQUFDLE9BQU8sQ0FBQyxrQkFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO2FBQ3ZDO1lBRUQsSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFO2dCQUN4QixjQUFjLENBQUMsT0FBTyxDQUFDLGtCQUFVLEVBQUUsR0FBRyxDQUFDLENBQUM7YUFDekM7WUFFRCxJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQztRQUNwQixDQUFDOzs7T0FaQTtJQWNELDhCQUFRLEdBQVI7UUFBQSxpQkFjQztRQWJDLElBQU0sTUFBTSxHQUFHO1lBQ2IsTUFBTSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTTtTQUM1QixDQUFDO1FBQ0YsT0FBTyxtQkFBUzthQUNiLEdBQUcsQ0FBSSxJQUFJLENBQUMsV0FBVyxjQUFXLEVBQUUsRUFBRSxNQUFNLFFBQUEsRUFBRSxDQUFDO2FBQy9DLElBQUksQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLEdBQUcsQ0FBQyxJQUFJLEVBQVIsQ0FBUSxDQUFDO2FBQ3JCLElBQUksQ0FBQyxVQUFBLElBQUk7WUFDUixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7Z0JBQ3RCLEtBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO2FBQzdCO1lBRUQsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCwwQkFBSSxHQUFKLFVBQUssTUFBVyxFQUFFLGdCQUFzQjtRQUF4QyxpQkFrQ0M7UUFqQ0MsSUFBTSxPQUFPLEdBQVE7WUFDbkIsTUFBTSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTTtZQUMzQixNQUFNLFFBQUE7WUFDTixJQUFJLEVBQUUsS0FBSztZQUNYLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSztTQUNsQixDQUFDO1FBRUYsSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFO1lBQ3hCLE9BQU8sQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1NBQ3ZDO1FBRUQsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRTtZQUNqRCxPQUFPLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDO1lBQ3JDLE9BQU8sQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUM7U0FDNUM7UUFFRCxJQUFJLE9BQU8sR0FBUSxFQUFFLENBQUM7UUFFdEIsSUFBSSxnQkFBZ0IsRUFBRTtZQUNwQixJQUFNLFdBQVcsR0FBRyxJQUFJLHVCQUFhLEVBQUUsQ0FBQztZQUN4QyxnQkFBZ0IsQ0FBQyxNQUFNLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDL0QsT0FBTyxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7U0FDbkM7UUFFRCxPQUFPLG1CQUFTO2FBQ2IsSUFBSSxDQUFJLElBQUksQ0FBQyxXQUFXLGlCQUFjLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQzthQUN6RCxJQUFJLENBQUMsVUFBQSxHQUFHO1lBQ1AsSUFBSSxHQUFHLENBQUMsSUFBSSxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFO2dCQUM5QixLQUFJLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO2FBQzdCO1lBRUQsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ2xCLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELDJCQUFLLEdBQUwsVUFBTSxJQUFZLEVBQUUsSUFBWSxFQUFFLE9BQXlCLEVBQUUsWUFBc0IsRUFBRSxnQkFBc0I7O1FBQTNHLGlCQW9EQztRQXBEaUMsd0JBQUEsRUFBQSxZQUF5QjtRQUFFLDZCQUFBLEVBQUEsaUJBQXNCO1FBQ2pGLGdCQUFnQjtRQUNoQixJQUFJLE9BQU8sQ0FBQyxRQUFRLEtBQUssU0FBUyxFQUFFO1lBQ2xDLE9BQU8sQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1NBQ3pCO1FBRUQsSUFBTSxPQUFPLEdBQVE7WUFDbkIsTUFBTSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTTtZQUMzQixLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7WUFDakIsSUFBSSxFQUFFLEtBQUs7WUFDWCxNQUFNO2dCQUNKLEdBQUMsSUFBSSxJQUFHO29CQUNOLElBQUksTUFBQTtvQkFDSixLQUFLLEVBQUUsbUJBQVcsQ0FBQyxPQUFPLENBQUM7aUJBQzVCO21CQUNGO1NBQ0YsQ0FBQztRQUVGLElBQUksSUFBSSxLQUFLLGNBQWMsSUFBSSxZQUFZLENBQUMsZ0JBQWdCLEVBQUU7WUFDNUQsT0FBTyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLEdBQUcsWUFBWSxDQUFDLGdCQUFnQixDQUFDO1NBQzlFO1FBRUQsSUFBSSxJQUFJLEtBQUssY0FBYyxJQUFJLFlBQVksQ0FBQyxxQkFBcUIsRUFBRTtZQUNqRSxPQUFPLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxxQkFBcUIsR0FBRyxZQUFZLENBQUMscUJBQXFCLENBQUM7U0FDeEY7UUFFRCxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFO1lBQ2pELE9BQU8sQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7WUFDckMsT0FBTyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztTQUM1QztRQUVELElBQUksY0FBYyxHQUFRLEVBQUUsQ0FBQztRQUU3QixJQUFJLGdCQUFnQixFQUFFO1lBQ3BCLElBQU0sV0FBVyxHQUFHLElBQUksdUJBQWEsRUFBRSxDQUFDO1lBQ3hDLGdCQUFnQixDQUFDLE1BQU0sR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUMvRCxjQUFjLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztTQUMxQztRQUVELE9BQU8sbUJBQVM7YUFDYixJQUFJLENBQUksSUFBSSxDQUFDLFdBQVcsWUFBUyxFQUFFLE9BQU8sRUFBRSxjQUFjLENBQUM7YUFDM0QsSUFBSSxDQUFDLFVBQUEsR0FBRztZQUNQLElBQUksR0FBRyxDQUFDLElBQUksSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRTtnQkFDOUIsS0FBSSxDQUFDLEtBQUssR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQzthQUM3QjtZQUVELElBQUksR0FBRyxDQUFDLElBQUksSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUM5QixPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDdkI7WUFFRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDbEIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsNEJBQU0sR0FBTixVQUFPLElBQWE7O1FBQ2xCLElBQU0sT0FBTyxHQUFRO1lBQ25CLE1BQU0sRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU07WUFDM0IsSUFBSSxFQUFFLEtBQUs7WUFDWCxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7U0FDbEIsQ0FBQztRQUVGLElBQUksSUFBSSxFQUFFO1lBQ1IsT0FBTyxDQUFDLE1BQU0sYUFBSyxHQUFDLElBQUksSUFBRyxFQUFFLEtBQUUsQ0FBQztTQUNqQzthQUFNO1lBQ0wsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO2dCQUNkLDJEQUEyRDtnQkFDM0QsWUFBWSxDQUFDLFVBQVUsQ0FBQyxrQkFBVSxDQUFDLENBQUM7YUFDckM7WUFFRCxJQUFJLElBQUksQ0FBQyxlQUFlLEVBQUU7Z0JBQ3hCLGNBQWMsQ0FBQyxVQUFVLENBQUMsa0JBQVUsQ0FBQyxDQUFDO2FBQ3ZDO1NBQ0Y7UUFFRCxPQUFPLG1CQUFTO2FBQ2IsSUFBSSxDQUFJLElBQUksQ0FBQyxXQUFXLGlCQUFjLEVBQUUsT0FBTyxDQUFDO2FBQ2hELElBQUksQ0FBQyxVQUFBLEdBQUc7WUFDUCxJQUFJLEdBQUcsQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDOUIsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3ZCO1lBQ0QsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ2xCLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELDhCQUFRLEdBQVIsVUFBUyxHQUFXO1FBQ2xCLElBQU0sT0FBTyxHQUFRO1lBQ25CLE1BQU0sRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU07WUFDM0IsR0FBRyxLQUFBO1NBQ0osQ0FBQztRQUVGLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUU7WUFDakQsT0FBTyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztZQUNyQyxPQUFPLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDO1NBQzVDO1FBRUQsT0FBTyxtQkFBUzthQUNiLElBQUksQ0FBSSxJQUFJLENBQUMsV0FBVyxjQUFXLEVBQUUsT0FBTyxDQUFDO2FBQzdDLElBQUksQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLEdBQUcsQ0FBQyxJQUFJLEVBQVIsQ0FBUSxDQUFDLENBQUM7SUFDM0IsQ0FBQztJQUVELHdCQUF3QjtJQUN4Qiw2QkFBTyxHQUFQLFVBQVEsSUFBWTtRQUNsQixJQUFJLElBQUksS0FBSyxPQUFPLElBQUksSUFBSSxLQUFLLE9BQU8sRUFBRTtZQUN4QyxNQUFNLElBQUksZ0NBQWMsQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO1NBQ2pFO1FBQ0QsT0FBTyxtQkFBUzthQUNiLElBQUksQ0FBSSxJQUFJLENBQUMsV0FBVyxtQkFBYyxJQUFJLFVBQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLEdBQUcsQ0FBQyxJQUFJLEVBQVIsQ0FBUSxDQUFDLENBQUM7SUFDOUUsQ0FBQztJQUVELDhCQUFRLEdBQVIsVUFBUyxJQUFZLEVBQUUsR0FBVyxFQUFFLFNBQWlCO1FBQ25ELElBQUksSUFBSSxLQUFLLE9BQU8sSUFBSSxJQUFJLEtBQUssT0FBTyxFQUFFO1lBQ3hDLE1BQU0sSUFBSSxnQ0FBYyxDQUFDLHFDQUFxQyxDQUFDLENBQUM7U0FDakU7UUFDRCxJQUFNLE9BQU8sR0FBRztZQUNkLE1BQU0sRUFBRSxHQUFHO1lBQ1gsVUFBVSxFQUFFLFNBQVM7U0FDdEIsQ0FBQztRQUVGLE9BQU8sbUJBQVM7YUFDYixJQUFJLENBQUksSUFBSSxDQUFDLFdBQVcsbUJBQWMsSUFBSSxXQUFRLEVBQUUsT0FBTyxDQUFDO2FBQzVELElBQUksQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLEdBQUcsQ0FBQyxJQUFJLEVBQVIsQ0FBUSxDQUFDLENBQUM7SUFDM0IsQ0FBQztJQUVELDZCQUFPLEdBQVAsVUFBUSxJQUFZLEVBQUUsR0FBVyxFQUFFLFNBQWlCLEVBQUUsU0FBaUI7UUFDckUsSUFBSSxJQUFJLEtBQUssT0FBTyxJQUFJLElBQUksS0FBSyxPQUFPLEVBQUU7WUFDeEMsTUFBTSxJQUFJLGdDQUFjLENBQUMscUNBQXFDLENBQUMsQ0FBQztTQUNqRTtRQUVELElBQU0sT0FBTyxHQUFHO1lBQ2QsTUFBTSxFQUFFLEdBQUc7WUFDWCxVQUFVLEVBQUUsU0FBUztZQUNyQixVQUFVLEVBQUUsU0FBUztTQUN0QixDQUFDO1FBRUYsT0FBTyxtQkFBUzthQUNiLElBQUksQ0FBSSxJQUFJLENBQUMsV0FBVyxtQkFBYyxJQUFJLFVBQU8sRUFBRSxPQUFPLENBQUM7YUFDM0QsSUFBSSxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxDQUFDLElBQUksRUFBUixDQUFRLENBQUMsQ0FBQztJQUMzQixDQUFDO0lBRU8sbUNBQWEsR0FBckI7UUFDRSxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsRUFBRTtZQUMzQixPQUFPLFNBQVMsQ0FBQztTQUNsQjtRQUVELHNDQUFzQztRQUN0Qyx3R0FBd0c7UUFDeEcsOEVBQThFO1FBQzlFLElBQU0sWUFBWSxHQUFHLElBQUksZUFBZSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDakUsWUFBWSxDQUFDLEdBQUcsQ0FBQyx3QkFBZ0IsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUUzQyxPQUFVLE1BQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxVQUFLLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxTQUFJLFlBQVksQ0FBQyxRQUFRLEVBQUksQ0FBQztJQUN0SCxDQUFDO0lBQ0gsa0JBQUM7QUFBRCxDQTdRQSxBQTZRQyxJQUFBO0FBN1FZLGtDQUFXIiwiZmlsZSI6ImxpYi9hcGkvY2xvdWQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IChjKSAyMDE4IGJ5IEZpbGVzdGFjay5cbiAqIFNvbWUgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyByZW1vdmVFbXB0eSB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IFN0b3JlUGFyYW1zIH0gZnJvbSAnLi4vZmlsZWxpbmsnO1xuaW1wb3J0IHsgQ2xpZW50T3B0aW9ucywgU2Vzc2lvbiB9IGZyb20gJy4uL2NsaWVudCc7XG4vLyBpbXBvcnQgeyByZXF1ZXN0V2l0aFNvdXJjZSwgcmVxdWVzdCB9IGZyb20gJy4uL2FwaS9yZXF1ZXN0JztcbmltcG9ydCB7IEZpbGVzdGFja0Vycm9yIH0gZnJvbSAnLi8uLi8uLi9maWxlc3RhY2tfZXJyb3InO1xuaW1wb3J0IHsgRnNSZXF1ZXN0LCBGc0NhbmNlbFRva2VuIH0gZnJvbSAnLi4vcmVxdWVzdCc7XG5cbi8qKlxuICogQHByaXZhdGVcbiAqL1xuZXhwb3J0IGNvbnN0IFBJQ0tFUl9LRVkgPSAnX19mc19waWNrZXJfdG9rZW4nO1xuXG4vKipcbiAqIGtleSBmb3IgcGlja2VyIGNhbGxiYWNrIHVybCAoc3BlY2lmaWVzIHdoaWNoIHRhYiB3aWxsIGJlIG9wZW5lZCBhZnRlciBvcGVuaW5nIHBpY2tlcilcbiAqIEBwcml2YXRlXG4gKi9cbmV4cG9ydCBjb25zdCBDQUxMQkFDS19VUkxfS0VZID0gJ2ZzLXRhYic7XG5cbi8qKlxuICogQHByaXZhdGVcbiAqL1xuZXhwb3J0IGNsYXNzIENsb3VkQ2xpZW50IHtcbiAgc2Vzc2lvbjogU2Vzc2lvbjtcbiAgY2xvdWRBcGlVcmw6IHN0cmluZztcblxuICAvKipcbiAgICogUmV0dXJucyBmbGFnIGlmIHRva2VuIHNob3VsZCBiZSBjYWNoZWQgaW4gbG9jYWwgc3RvcmFnZVxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAdHlwZSB7Ym9vbGVhbn1cbiAgICogQG1lbWJlcm9mIENsb3VkQ2xpZW50XG4gICAqL1xuICBwcml2YXRlIGNhY2hlOiBib29sZWFuID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIFRva2VuIHJldHVybmVkIGZyb20gYXBpIGZvciBhY2Nlc3NpbmcgY2xvdWRzXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEB0eXBlIHtzdHJpbmd9XG4gICAqIEBtZW1iZXJvZiBDbG91ZENsaWVudFxuICAgKi9cbiAgcHJpdmF0ZSBfdG9rZW46IHN0cmluZztcblxuICAvKipcbiAgICogRmxhZyBmb3IgaW4tYXBwIGJyb3dzZXIgc2V0dXBcbiAgICogKGluLWFwcCBicm93c2VycyBhcmUgbm90IHN1cHBvcnRpbmcgbmV3IHdpbmRvdyBzbyB3ZSBuZWVkIHRvIHNhdmUgdG9rZW4gdG8gc2Vzc2lvbiBjYWNoZSlcbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQG1lbWJlcm9mIENsb3VkQ2xpZW50XG4gICAqL1xuICBwcml2YXRlIF9pc0luQXBwQnJvd3NlciA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKHNlc3Npb246IFNlc3Npb24sIG9wdGlvbnM/OiBDbGllbnRPcHRpb25zKSB7XG4gICAgdGhpcy5zZXNzaW9uID0gc2Vzc2lvbjtcbiAgICB0aGlzLmNsb3VkQXBpVXJsID0gc2Vzc2lvbi51cmxzLmNsb3VkQXBpVXJsO1xuXG4gICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5zZXNzaW9uQ2FjaGUpIHtcbiAgICAgIHRoaXMuY2FjaGUgPSBvcHRpb25zLnNlc3Npb25DYWNoZTtcbiAgICB9XG4gIH1cblxuICBnZXQgdG9rZW4oKSB7XG4gICAgaWYgKHRoaXMuY2FjaGUpIHtcbiAgICAgIGNvbnN0IHRva2VuID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oUElDS0VSX0tFWSk7XG4gICAgICBpZiAodG9rZW4pIHJldHVybiB0b2tlbjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5faXNJbkFwcEJyb3dzZXIpIHtcbiAgICAgIHJldHVybiBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKFBJQ0tFUl9LRVkpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl90b2tlbjtcbiAgfVxuXG4gIHNldCB0b2tlbihrZXkpIHtcbiAgICBpZiAodGhpcy5jYWNoZSkge1xuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oUElDS0VSX0tFWSwga2V5KTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5faXNJbkFwcEJyb3dzZXIpIHtcbiAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oUElDS0VSX0tFWSwga2V5KTtcbiAgICB9XG5cbiAgICB0aGlzLl90b2tlbiA9IGtleTtcbiAgfVxuXG4gIHByZWZldGNoKCkge1xuICAgIGNvbnN0IHBhcmFtcyA9IHtcbiAgICAgIGFwaWtleTogdGhpcy5zZXNzaW9uLmFwaWtleSxcbiAgICB9O1xuICAgIHJldHVybiBGc1JlcXVlc3RcbiAgICAgIC5nZXQoYCR7dGhpcy5jbG91ZEFwaVVybH0vcHJlZmV0Y2hgLCB7IHBhcmFtcyB9KVxuICAgICAgLnRoZW4ocmVzID0+IHJlcy5kYXRhKVxuICAgICAgLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgIGlmIChkYXRhLmluYXBwX2Jyb3dzZXIpIHtcbiAgICAgICAgICB0aGlzLl9pc0luQXBwQnJvd3NlciA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgIH0pO1xuICB9XG5cbiAgbGlzdChjbG91ZHM6IGFueSwgY2FuY2VsVG9rZW5JbnB1dD86IGFueSkge1xuICAgIGNvbnN0IHBheWxvYWQ6IGFueSA9IHtcbiAgICAgIGFwaWtleTogdGhpcy5zZXNzaW9uLmFwaWtleSxcbiAgICAgIGNsb3VkcyxcbiAgICAgIGZsb3c6ICd3ZWInLFxuICAgICAgdG9rZW46IHRoaXMudG9rZW4sXG4gICAgfTtcblxuICAgIGlmICh0aGlzLl9pc0luQXBwQnJvd3Nlcikge1xuICAgICAgcGF5bG9hZC5hcHB1cmwgPSB0aGlzLmN1cnJlbnRBcHBVcmwoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zZXNzaW9uLnBvbGljeSAmJiB0aGlzLnNlc3Npb24uc2lnbmF0dXJlKSB7XG4gICAgICBwYXlsb2FkLnBvbGljeSA9IHRoaXMuc2Vzc2lvbi5wb2xpY3k7XG4gICAgICBwYXlsb2FkLnNpZ25hdHVyZSA9IHRoaXMuc2Vzc2lvbi5zaWduYXR1cmU7XG4gICAgfVxuXG4gICAgbGV0IG9wdGlvbnM6IGFueSA9IHt9O1xuXG4gICAgaWYgKGNhbmNlbFRva2VuSW5wdXQpIHtcbiAgICAgIGNvbnN0IGNhbmNlbFRva2VuID0gbmV3IEZzQ2FuY2VsVG9rZW4oKTtcbiAgICAgIGNhbmNlbFRva2VuSW5wdXQuY2FuY2VsID0gY2FuY2VsVG9rZW4uY2FuY2VsLmJpbmQoY2FuY2VsVG9rZW4pO1xuICAgICAgb3B0aW9ucy5jYW5jZWxUb2tlbiA9IGNhbmNlbFRva2VuO1xuICAgIH1cblxuICAgIHJldHVybiBGc1JlcXVlc3RcbiAgICAgIC5wb3N0KGAke3RoaXMuY2xvdWRBcGlVcmx9L2ZvbGRlci9saXN0YCwgcGF5bG9hZCwgb3B0aW9ucylcbiAgICAgIC50aGVuKHJlcyA9PiB7XG4gICAgICAgIGlmIChyZXMuZGF0YSAmJiByZXMuZGF0YS50b2tlbikge1xuICAgICAgICAgIHRoaXMudG9rZW4gPSByZXMuZGF0YS50b2tlbjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXMuZGF0YTtcbiAgICAgIH0pO1xuICB9XG5cbiAgc3RvcmUobmFtZTogc3RyaW5nLCBwYXRoOiBzdHJpbmcsIG9wdGlvbnM6IFN0b3JlUGFyYW1zID0ge30sIGN1c3RvbVNvdXJjZTogYW55ID0ge30sIGNhbmNlbFRva2VuSW5wdXQ/OiBhbnkpIHtcbiAgICAvLyBEZWZhdWx0IHRvIFMzXG4gICAgaWYgKG9wdGlvbnMubG9jYXRpb24gPT09IHVuZGVmaW5lZCkge1xuICAgICAgb3B0aW9ucy5sb2NhdGlvbiA9ICdzMyc7XG4gICAgfVxuXG4gICAgY29uc3QgcGF5bG9hZDogYW55ID0ge1xuICAgICAgYXBpa2V5OiB0aGlzLnNlc3Npb24uYXBpa2V5LFxuICAgICAgdG9rZW46IHRoaXMudG9rZW4sXG4gICAgICBmbG93OiAnd2ViJyxcbiAgICAgIGNsb3Vkczoge1xuICAgICAgICBbbmFtZV06IHtcbiAgICAgICAgICBwYXRoLFxuICAgICAgICAgIHN0b3JlOiByZW1vdmVFbXB0eShvcHRpb25zKSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIGlmIChuYW1lID09PSAnY3VzdG9tc291cmNlJyAmJiBjdXN0b21Tb3VyY2UuY3VzdG9tU291cmNlUGF0aCkge1xuICAgICAgcGF5bG9hZC5jbG91ZHMuY3VzdG9tc291cmNlLmN1c3RvbVNvdXJjZVBhdGggPSBjdXN0b21Tb3VyY2UuY3VzdG9tU291cmNlUGF0aDtcbiAgICB9XG5cbiAgICBpZiAobmFtZSA9PT0gJ2N1c3RvbXNvdXJjZScgJiYgY3VzdG9tU291cmNlLmN1c3RvbVNvdXJjZUNvbnRhaW5lcikge1xuICAgICAgcGF5bG9hZC5jbG91ZHMuY3VzdG9tc291cmNlLmN1c3RvbVNvdXJjZUNvbnRhaW5lciA9IGN1c3RvbVNvdXJjZS5jdXN0b21Tb3VyY2VDb250YWluZXI7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc2Vzc2lvbi5wb2xpY3kgJiYgdGhpcy5zZXNzaW9uLnNpZ25hdHVyZSkge1xuICAgICAgcGF5bG9hZC5wb2xpY3kgPSB0aGlzLnNlc3Npb24ucG9saWN5O1xuICAgICAgcGF5bG9hZC5zaWduYXR1cmUgPSB0aGlzLnNlc3Npb24uc2lnbmF0dXJlO1xuICAgIH1cblxuICAgIGxldCByZXF1ZXN0T3B0aW9uczogYW55ID0ge307XG5cbiAgICBpZiAoY2FuY2VsVG9rZW5JbnB1dCkge1xuICAgICAgY29uc3QgY2FuY2VsVG9rZW4gPSBuZXcgRnNDYW5jZWxUb2tlbigpO1xuICAgICAgY2FuY2VsVG9rZW5JbnB1dC5jYW5jZWwgPSBjYW5jZWxUb2tlbi5jYW5jZWwuYmluZChjYW5jZWxUb2tlbik7XG4gICAgICByZXF1ZXN0T3B0aW9ucy5jYW5jZWxUb2tlbiA9IGNhbmNlbFRva2VuO1xuICAgIH1cblxuICAgIHJldHVybiBGc1JlcXVlc3RcbiAgICAgIC5wb3N0KGAke3RoaXMuY2xvdWRBcGlVcmx9L3N0b3JlL2AsIHBheWxvYWQsIHJlcXVlc3RPcHRpb25zKVxuICAgICAgLnRoZW4ocmVzID0+IHtcbiAgICAgICAgaWYgKHJlcy5kYXRhICYmIHJlcy5kYXRhLnRva2VuKSB7XG4gICAgICAgICAgdGhpcy50b2tlbiA9IHJlcy5kYXRhLnRva2VuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJlcy5kYXRhICYmIHJlcy5kYXRhW25hbWVdKSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5kYXRhW25hbWVdO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlcy5kYXRhO1xuICAgICAgfSk7XG4gIH1cblxuICBsb2dvdXQobmFtZT86IHN0cmluZykge1xuICAgIGNvbnN0IHBheWxvYWQ6IGFueSA9IHtcbiAgICAgIGFwaWtleTogdGhpcy5zZXNzaW9uLmFwaWtleSxcbiAgICAgIGZsb3c6ICd3ZWInLFxuICAgICAgdG9rZW46IHRoaXMudG9rZW4sXG4gICAgfTtcblxuICAgIGlmIChuYW1lKSB7XG4gICAgICBwYXlsb2FkLmNsb3VkcyA9IHsgW25hbWVdOiB7fSB9O1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5jYWNoZSkge1xuICAgICAgICAvLyBObyBuYW1lIG1lYW5zIGxvZ291dCBvZiBBTEwgY2xvdWRzLiBDbGVhciBsb2NhbCBzZXNzaW9uLlxuICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShQSUNLRVJfS0VZKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMuX2lzSW5BcHBCcm93c2VyKSB7XG4gICAgICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oUElDS0VSX0tFWSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIEZzUmVxdWVzdFxuICAgICAgLnBvc3QoYCR7dGhpcy5jbG91ZEFwaVVybH0vYXV0aC9sb2dvdXRgLCBwYXlsb2FkKVxuICAgICAgLnRoZW4ocmVzID0+IHtcbiAgICAgICAgaWYgKHJlcy5kYXRhICYmIHJlcy5kYXRhW25hbWVdKSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5kYXRhW25hbWVdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXMuZGF0YTtcbiAgICAgIH0pO1xuICB9XG5cbiAgbWV0YWRhdGEodXJsOiBzdHJpbmcpIHtcbiAgICBjb25zdCBwYXlsb2FkOiBhbnkgPSB7XG4gICAgICBhcGlrZXk6IHRoaXMuc2Vzc2lvbi5hcGlrZXksXG4gICAgICB1cmwsXG4gICAgfTtcblxuICAgIGlmICh0aGlzLnNlc3Npb24ucG9saWN5ICYmIHRoaXMuc2Vzc2lvbi5zaWduYXR1cmUpIHtcbiAgICAgIHBheWxvYWQucG9saWN5ID0gdGhpcy5zZXNzaW9uLnBvbGljeTtcbiAgICAgIHBheWxvYWQuc2lnbmF0dXJlID0gdGhpcy5zZXNzaW9uLnNpZ25hdHVyZTtcbiAgICB9XG5cbiAgICByZXR1cm4gRnNSZXF1ZXN0XG4gICAgICAucG9zdChgJHt0aGlzLmNsb3VkQXBpVXJsfS9tZXRhZGF0YWAsIHBheWxvYWQpXG4gICAgICAudGhlbihyZXMgPT4gcmVzLmRhdGEpO1xuICB9XG5cbiAgLy8gT3BlblRvayBBUEkgRW5kcG9pbnRzXG4gIHRva0luaXQodHlwZTogc3RyaW5nKSB7XG4gICAgaWYgKHR5cGUgIT09ICd2aWRlbycgJiYgdHlwZSAhPT0gJ2F1ZGlvJykge1xuICAgICAgdGhyb3cgbmV3IEZpbGVzdGFja0Vycm9yKCdUeXBlIG11c3QgYmUgb25lIG9mIHZpZGVvIG9yIGF1ZGlvLicpO1xuICAgIH1cbiAgICByZXR1cm4gRnNSZXF1ZXN0XG4gICAgICAucG9zdChgJHt0aGlzLmNsb3VkQXBpVXJsfS9yZWNvcmRpbmcvJHt0eXBlfS9pbml0YCkudGhlbihyZXMgPT4gcmVzLmRhdGEpO1xuICB9XG5cbiAgdG9rU3RhcnQodHlwZTogc3RyaW5nLCBrZXk6IHN0cmluZywgc2Vzc2lvbklkOiBzdHJpbmcpIHtcbiAgICBpZiAodHlwZSAhPT0gJ3ZpZGVvJyAmJiB0eXBlICE9PSAnYXVkaW8nKSB7XG4gICAgICB0aHJvdyBuZXcgRmlsZXN0YWNrRXJyb3IoJ1R5cGUgbXVzdCBiZSBvbmUgb2YgdmlkZW8gb3IgYXVkaW8uJyk7XG4gICAgfVxuICAgIGNvbnN0IHBheWxvYWQgPSB7XG4gICAgICBhcGlrZXk6IGtleSxcbiAgICAgIHNlc3Npb25faWQ6IHNlc3Npb25JZCxcbiAgICB9O1xuXG4gICAgcmV0dXJuIEZzUmVxdWVzdFxuICAgICAgLnBvc3QoYCR7dGhpcy5jbG91ZEFwaVVybH0vcmVjb3JkaW5nLyR7dHlwZX0vc3RhcnRgLCBwYXlsb2FkKVxuICAgICAgLnRoZW4ocmVzID0+IHJlcy5kYXRhKTtcbiAgfVxuXG4gIHRva1N0b3AodHlwZTogc3RyaW5nLCBrZXk6IHN0cmluZywgc2Vzc2lvbklkOiBzdHJpbmcsIGFyY2hpdmVJZDogc3RyaW5nKSB7XG4gICAgaWYgKHR5cGUgIT09ICd2aWRlbycgJiYgdHlwZSAhPT0gJ2F1ZGlvJykge1xuICAgICAgdGhyb3cgbmV3IEZpbGVzdGFja0Vycm9yKCdUeXBlIG11c3QgYmUgb25lIG9mIHZpZGVvIG9yIGF1ZGlvLicpO1xuICAgIH1cblxuICAgIGNvbnN0IHBheWxvYWQgPSB7XG4gICAgICBhcGlrZXk6IGtleSxcbiAgICAgIHNlc3Npb25faWQ6IHNlc3Npb25JZCxcbiAgICAgIGFyY2hpdmVfaWQ6IGFyY2hpdmVJZCxcbiAgICB9O1xuXG4gICAgcmV0dXJuIEZzUmVxdWVzdFxuICAgICAgLnBvc3QoYCR7dGhpcy5jbG91ZEFwaVVybH0vcmVjb3JkaW5nLyR7dHlwZX0vc3RvcGAsIHBheWxvYWQpXG4gICAgICAudGhlbihyZXMgPT4gcmVzLmRhdGEpO1xuICB9XG5cbiAgcHJpdmF0ZSBjdXJyZW50QXBwVXJsKCkge1xuICAgIGlmICghd2luZG93LlVSTFNlYXJjaFBhcmFtcykge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICAvLyBzZXQgaW5pdCBzdHJpbmcgZm9yIGNsb3VkcyBiYWNrZW5kLFxuICAgIC8vIEFmdGVyIHRoaXMgY2xvdWQgc2VydmljZSBjYW4gbWFrZSByZWRpcmVjdCBiYWNrIHRvIGN1cnJlbnQgcGFnZSB1cmwgd2l0aCBzZWxlY3RlZCB0YWIgZm9yIGdpdmVuIGNsb3VkXG4gICAgLy8gaWYgcGFyYW0gZXhpc3RzIGFuZCBpdHMgdmFsdWUgaXMgaW5pdCwgYmFja2VuZCB3aWxsIGZpbGwgaXQgd2l0aCBjbG91ZCBuYW1lXG4gICAgY29uc3Qgc2VhcmNoUGFyYW1zID0gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKTtcbiAgICBzZWFyY2hQYXJhbXMuc2V0KENBTExCQUNLX1VSTF9LRVksICdpbml0Jyk7XG5cbiAgICByZXR1cm4gYCR7d2luZG93LmxvY2F0aW9uLnByb3RvY29sfS8vJHt3aW5kb3cubG9jYXRpb24uaG9zdH0ke3dpbmRvdy5sb2NhdGlvbi5wYXRobmFtZX0/JHtzZWFyY2hQYXJhbXMudG9TdHJpbmcoKX1gO1xuICB9XG59XG4iXX0=
