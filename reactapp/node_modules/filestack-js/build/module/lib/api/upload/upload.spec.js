/*
 * Copyright (c) 2019 by Filestack.
 * Some rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { __awaiter, __generator } from "tslib";
import { Upload } from './upload';
import { S3Uploader } from './uploaders/s3';
import { config } from './../../../config';
var testBuffer = Buffer.from('test test test');
var customNameMocked = jest.fn();
var mockedFsFile = {};
Object.defineProperty(mockedFsFile, 'customName', {
    set: customNameMocked,
});
jest.useFakeTimers();
jest.mock('./uploaders/s3');
jest.mock('./file_tools', function () { return ({
    getFile: jest.fn().mockImplementation(function () { return mockedFsFile; }),
}); });
var mockedFileResponse = {
    status: 'stored',
};
var sessionURls = config.urls;
var defaultSession = {
    apikey: 'test',
    policy: 'p',
    signature: 's',
    urls: sessionURls,
};
var mockExecute = jest.fn();
describe('Api/Upload/upload', function () {
    beforeAll(function () {
        spyOn(S3Uploader.prototype, 'execute').and.callFake(mockExecute);
    });
    describe('Settings', function () {
        it('should handle constructor options', function () {
            var u = new Upload({
                partSize: 5 * 1024 * 1024,
                intelligentChunkSize: 5 * 1024 * 1024,
            });
            expect(S3Uploader.prototype.setPartSize).toHaveBeenCalledWith(5 * 1024 * 1024);
            expect(S3Uploader.prototype.setIntelligentChunkSize).toHaveBeenCalledWith(5 * 1024 * 1024);
        });
        it('should throw error on wrong upload options', function () {
            // @ts-ignore
            expect(function () { return new Upload({ intelligent1: true }); }).toThrowError('Invalid upload params');
        });
        it('should accept sanitizer settings', function () {
            expect(function () { return new Upload({}, {
                // @ts-ignore
                sanitizer: false,
            }); }).not.toThrowError('Invalid upload params');
            expect(function () { return new Upload({}, {
                // @ts-ignore
                sanitizer: {
                    exclude: ['1'],
                    replacement: '-',
                },
            }); }).not.toThrowError('Invalid upload params');
        });
        it('should throw error on wrong store options', function () {
            // @ts-ignore
            expect(function () { return new Upload({ intelligent: true }, { test: 123 }); }).toThrowError('Invalid store upload params');
        });
        it('should set intelligent upload mode', function () {
            var u = new Upload({ intelligent: true });
            expect(S3Uploader.prototype.setUploadMode).toHaveBeenCalledWith("intelligent" /* INTELLIGENT */);
        });
        it('should set respect disableIntegrityCheck param', function () {
            var u = new Upload({ disableIntegrityCheck: true });
            expect(S3Uploader.prototype.setIntegrityCheck).toHaveBeenCalledWith(false);
        });
        it('should fallback upload mode', function () {
            var u = new Upload({ intelligent: 'fallback' });
            expect(S3Uploader.prototype.setUploadMode).toHaveBeenCalledWith("fallback" /* FALLBACK */);
        });
        it('should pass store options to uploader class', function () {
            var storeOptions = {
                location: 's3',
            };
            var u = new Upload({}, storeOptions);
            expect(S3Uploader.prototype.constructor).toHaveBeenCalledWith(storeOptions, undefined);
        });
        it('should respect concurrency param in upload options', function () {
            var uploadOptions = {
                concurrency: 4,
            };
            var u = new Upload(uploadOptions);
            expect(S3Uploader.prototype.constructor).toHaveBeenCalledWith({}, 4);
        });
        it('should set correct security to uploader', function () {
            var security = {
                policy: 'p',
                signature: 's',
            };
            var u = new Upload();
            u.setSecurity(security);
            expect(S3Uploader.prototype.setSecurity).toHaveBeenCalledWith(security);
        });
        it('should pass session variable to uploader', function () {
            var u = new Upload();
            u.setSession(defaultSession);
            expect(S3Uploader.prototype.setUrl).toHaveBeenCalledWith(defaultSession.urls.uploadApiUrl);
            expect(S3Uploader.prototype.setApikey).toHaveBeenCalledWith(defaultSession.apikey);
            expect(S3Uploader.prototype.setSecurity).toHaveBeenCalledWith({ policy: defaultSession.policy, signature: defaultSession.signature });
        });
        it('should set storeOption filename to class', function () { return __awaiter(void 0, void 0, void 0, function () {
            var filenameFn, u;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        mockExecute.mockReturnValue(Promise.resolve([mockedFileResponse]));
                        filenameFn = function () { return 'test'; };
                        u = new Upload({}, {
                            filename: filenameFn,
                        });
                        return [4 /*yield*/, u.upload(testBuffer)];
                    case 1:
                        _a.sent();
                        expect(customNameMocked).toHaveBeenCalledWith(filenameFn);
                        return [2 /*return*/];
                }
            });
        }); });
        it('should assign methods to user provided token', function () {
            var token = {};
            var u = new Upload();
            u.setToken(token);
            expect(token['cancel']).toBeTruthy();
            expect(token['resume']).toBeTruthy();
            expect(token['pause']).toBeTruthy();
            token['cancel']();
            token['pause']();
            token['resume']();
        });
        it('should set token with methods that pause,cancel or resume uploads', function () {
            var token = {};
            var u = new Upload();
            u.setToken(token);
            token['cancel']();
            token['pause']();
            token['resume']();
            expect(S3Uploader.prototype.abort).toHaveBeenCalled();
            expect(S3Uploader.prototype.pause).toHaveBeenCalled();
            expect(S3Uploader.prototype.resume).toHaveBeenCalled();
        });
        it('should throw an error if token is not an object', function () {
            var token = '123123';
            var u = new Upload();
            expect(function () {
                u.setToken(token);
            }).toThrowError();
        });
    });
    describe('Upload', function () {
        beforeEach(function () {
            mockExecute.mockReturnValue(Promise.resolve([mockedFileResponse, mockedFileResponse]));
        });
        it('should execute normal upload without errors and return single file response', function () { return __awaiter(void 0, void 0, void 0, function () {
            var u, res;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        u = new Upload();
                        return [4 /*yield*/, u.upload(testBuffer)];
                    case 1:
                        res = _a.sent();
                        expect(res).toEqual(mockedFileResponse);
                        return [2 /*return*/];
                }
            });
        }); });
        it('should execute normal upload with errors and return rejected promise', function () {
            var u = new Upload();
            mockExecute.mockReturnValue(Promise.resolve([
                {
                    status: "Failed" /* FAILED */,
                },
            ]));
            return expect(u.upload(testBuffer)).rejects.toEqual({
                status: "Failed" /* FAILED */,
            });
        });
        it('should execute multiupload without errors and return single file response', function () { return __awaiter(void 0, void 0, void 0, function () {
            var u, res;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        u = new Upload();
                        return [4 /*yield*/, u.multiupload([testBuffer, testBuffer])];
                    case 1:
                        res = _a.sent();
                        expect(res).toEqual([mockedFileResponse, mockedFileResponse]);
                        return [2 /*return*/];
                }
            });
        }); });
    });
    describe('Progress', function () {
        var progress1 = {
            totalBytes: 1,
            totalPercent: 1,
            files: [
                {
                    totalBytes: 1,
                    totalPercent: 1,
                },
            ],
        };
        var progress50 = {
            totalBytes: 5,
            totalPercent: 50,
            files: [
                {
                    totalBytes: 50,
                    totalPercent: 50,
                },
            ],
        };
        var progress100 = {
            totalBytes: 100,
            totalPercent: 100,
            files: [
                {
                    totalBytes: 100,
                    totalPercent: 100,
                },
            ],
        };
        it('should handle correct progress event', function () { return __awaiter(void 0, void 0, void 0, function () {
            var progressMock, u;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        spyOn(S3Uploader.prototype, 'on').and.callFake(function (ev, cb) {
                            cb(progress1);
                            cb(progress100);
                        });
                        progressMock = jest.fn();
                        u = new Upload({
                            onProgress: progressMock,
                        });
                        return [4 /*yield*/, u.upload(testBuffer)];
                    case 1:
                        _a.sent();
                        expect(progressMock).toHaveBeenCalledWith(progress100);
                        expect(progressMock).toHaveBeenCalledTimes(1);
                        return [2 /*return*/];
                }
            });
        }); });
        it('should call progress event on given interval', function () { return __awaiter(void 0, void 0, void 0, function () {
            var progressCb, progressMock, u;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        mockExecute.mockImplementation(function () {
                            return new Promise(function (resolve) {
                                setTimeout(function () { return progressCb(progress1); }, 1);
                                setTimeout(function () { return progressCb(progress50); }, 2);
                                setTimeout(function () { return progressCb(progress100); }, 3);
                                setTimeout(function () { return resolve([]); }, 4);
                                jest.advanceTimersByTime(4);
                            });
                        });
                        spyOn(S3Uploader.prototype, 'on').and.callFake(function (ev, cb) {
                            progressCb = cb;
                        });
                        progressMock = jest.fn();
                        u = new Upload({
                            progressInterval: 1,
                            onProgress: progressMock,
                        });
                        return [4 /*yield*/, u.multiupload([testBuffer])];
                    case 1:
                        _a.sent();
                        expect(progressMock).toHaveBeenCalledWith(progress1);
                        expect(progressMock).toHaveBeenCalledWith(progress50);
                        expect(progressMock).toHaveBeenCalledWith(progress100);
                        return [2 /*return*/];
                }
            });
        }); });
        it('should stay at the same progress when uploader goes back with file progress', function () { return __awaiter(void 0, void 0, void 0, function () {
            var progressCb, progressMock, u;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        mockExecute.mockImplementation(function () {
                            return new Promise(function (resolve) {
                                setTimeout(function () { return progressCb(progress50); }, 1);
                                setTimeout(function () { return progressCb(progress1); }, 2);
                                setTimeout(function () { return progressCb(progress100); }, 3);
                                setTimeout(function () { return resolve([]); }, 4);
                                jest.advanceTimersByTime(4);
                            });
                        });
                        spyOn(S3Uploader.prototype, 'on').and.callFake(function (ev, cb) {
                            progressCb = cb;
                        });
                        progressMock = jest.fn();
                        u = new Upload({
                            progressInterval: 1,
                            onProgress: progressMock,
                        });
                        return [4 /*yield*/, u.multiupload([testBuffer])];
                    case 1:
                        _a.sent();
                        expect(progressMock).toHaveBeenCalledWith(progress50);
                        expect(progressMock).toHaveBeenCalledWith(progress50);
                        expect(progressMock).toHaveBeenCalledWith(progress100);
                        return [2 /*return*/];
                }
            });
        }); });
    });
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvYXBpL3VwbG9hZC91cGxvYWQuc3BlYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7O0FBRUgsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVsQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBSTNDLElBQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUVqRCxJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUVuQyxJQUFNLFlBQVksR0FBRyxFQUFFLENBQUM7QUFDeEIsTUFBTSxDQUFDLGNBQWMsQ0FBQyxZQUFZLEVBQUUsWUFBWSxFQUFFO0lBQ2hELEdBQUcsRUFBRSxnQkFBZ0I7Q0FDdEIsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0FBRXJCLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUM1QixJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxjQUFNLE9BQUEsQ0FBQztJQUMvQixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLGNBQU0sT0FBQSxZQUFZLEVBQVosQ0FBWSxDQUFDO0NBQzFELENBQUMsRUFGOEIsQ0FFOUIsQ0FBQyxDQUFDO0FBRUosSUFBTSxrQkFBa0IsR0FBRztJQUN6QixNQUFNLEVBQUUsUUFBUTtDQUNqQixDQUFDO0FBRUYsSUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztBQUNoQyxJQUFNLGNBQWMsR0FBRztJQUNyQixNQUFNLEVBQUUsTUFBTTtJQUNkLE1BQU0sRUFBRSxHQUFHO0lBQ1gsU0FBUyxFQUFFLEdBQUc7SUFDZCxJQUFJLEVBQUUsV0FBVztDQUNsQixDQUFDO0FBRUYsSUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBRTlCLFFBQVEsQ0FBQyxtQkFBbUIsRUFBRTtJQUM1QixTQUFTLENBQUM7UUFDUixLQUFLLENBQUMsVUFBVSxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ25FLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLFVBQVUsRUFBRTtRQUNuQixFQUFFLENBQUMsbUNBQW1DLEVBQUU7WUFDdEMsSUFBTSxDQUFDLEdBQUcsSUFBSSxNQUFNLENBQUM7Z0JBQ25CLFFBQVEsRUFBRSxDQUFDLEdBQUcsSUFBSSxHQUFHLElBQUk7Z0JBQ3pCLG9CQUFvQixFQUFFLENBQUMsR0FBRyxJQUFJLEdBQUcsSUFBSTthQUN0QyxDQUFDLENBQUM7WUFFSCxNQUFNLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDO1lBQy9FLE1BQU0sQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLHVCQUF1QixDQUFDLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxHQUFHLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQztRQUM3RixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyw0Q0FBNEMsRUFBRTtZQUMvQyxhQUFhO1lBQ2IsTUFBTSxDQUFDLGNBQU0sT0FBQSxJQUFJLE1BQU0sQ0FBQyxFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFsQyxDQUFrQyxDQUFDLENBQUMsWUFBWSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDekYsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsa0NBQWtDLEVBQUU7WUFDckMsTUFBTSxDQUFDLGNBQU0sT0FBQSxJQUFJLE1BQU0sQ0FBQyxFQUFFLEVBQUU7Z0JBQzFCLGFBQWE7Z0JBQ2IsU0FBUyxFQUFFLEtBQUs7YUFDakIsQ0FBQyxFQUhXLENBR1gsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsdUJBQXVCLENBQUMsQ0FBQztZQUU5QyxNQUFNLENBQUMsY0FBTSxPQUFBLElBQUksTUFBTSxDQUFDLEVBQUUsRUFBRTtnQkFDMUIsYUFBYTtnQkFDYixTQUFTLEVBQUU7b0JBQ1QsT0FBTyxFQUFFLENBQUMsR0FBRyxDQUFDO29CQUNkLFdBQVcsRUFBRSxHQUFHO2lCQUNqQjthQUNGLENBQUMsRUFOVyxDQU1YLENBQUMsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDaEQsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsMkNBQTJDLEVBQUU7WUFDOUMsYUFBYTtZQUNiLE1BQU0sQ0FBQyxjQUFNLE9BQUEsSUFBSSxNQUFNLENBQUMsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBaEQsQ0FBZ0QsQ0FBQyxDQUFDLFlBQVksQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO1FBQzdHLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLG9DQUFvQyxFQUFFO1lBQ3ZDLElBQU0sQ0FBQyxHQUFHLElBQUksTUFBTSxDQUFDLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7WUFDNUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUMsb0JBQW9CLGlDQUF3QixDQUFDO1FBQzFGLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLGdEQUFnRCxFQUFFO1lBQ25ELElBQU0sQ0FBQyxHQUFHLElBQUksTUFBTSxDQUFDLEVBQUUscUJBQXFCLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUN0RCxNQUFNLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdFLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDZCQUE2QixFQUFFO1lBQ2hDLElBQU0sQ0FBQyxHQUFHLElBQUksTUFBTSxDQUFDLEVBQUUsV0FBVyxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7WUFFbEQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUMsb0JBQW9CLDJCQUFxQixDQUFDO1FBQ3ZGLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDZDQUE2QyxFQUFFO1lBQ2hELElBQU0sWUFBWSxHQUF1QjtnQkFDdkMsUUFBUSxFQUFFLElBQUk7YUFDZixDQUFDO1lBRUYsSUFBTSxDQUFDLEdBQUcsSUFBSSxNQUFNLENBQUMsRUFBRSxFQUFFLFlBQVksQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLFlBQVksRUFBRSxTQUFTLENBQUMsQ0FBQztRQUN6RixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxvREFBb0QsRUFBRTtZQUN2RCxJQUFNLGFBQWEsR0FBRztnQkFDcEIsV0FBVyxFQUFFLENBQUM7YUFDZixDQUFDO1lBRUYsSUFBTSxDQUFDLEdBQUcsSUFBSSxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDcEMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUMsb0JBQW9CLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3ZFLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHlDQUF5QyxFQUFFO1lBQzVDLElBQU0sUUFBUSxHQUFHO2dCQUNmLE1BQU0sRUFBRSxHQUFHO2dCQUNYLFNBQVMsRUFBRSxHQUFHO2FBQ2YsQ0FBQztZQUVGLElBQU0sQ0FBQyxHQUFHLElBQUksTUFBTSxFQUFFLENBQUM7WUFDdkIsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUV4QixNQUFNLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMxRSxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQywwQ0FBMEMsRUFBRTtZQUM3QyxJQUFNLENBQUMsR0FBRyxJQUFJLE1BQU0sRUFBRSxDQUFDO1lBQ3ZCLENBQUMsQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUM7WUFFN0IsTUFBTSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsb0JBQW9CLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUMzRixNQUFNLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDbkYsTUFBTSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUMsb0JBQW9CLENBQUMsRUFBRSxNQUFNLEVBQUUsY0FBYyxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsY0FBYyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUM7UUFDeEksQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsMENBQTBDLEVBQUU7Ozs7O3dCQUM3QyxXQUFXLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDN0QsVUFBVSxHQUFHLGNBQU0sT0FBQSxNQUFNLEVBQU4sQ0FBTSxDQUFDO3dCQUUxQixDQUFDLEdBQUcsSUFBSSxNQUFNLENBQ2xCLEVBQUUsRUFDRjs0QkFDRSxRQUFRLEVBQUUsVUFBVTt5QkFDckIsQ0FDRixDQUFDO3dCQUVGLHFCQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQUE7O3dCQUExQixTQUEwQixDQUFDO3dCQUMzQixNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLENBQUMsQ0FBQzs7OzthQUMzRCxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsOENBQThDLEVBQUU7WUFDakQsSUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFDO1lBRWYsSUFBTSxDQUFDLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUN2QixDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRWxCLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNyQyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDckMsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBRXBDLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO1lBQ2xCLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ2pCLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO1FBQ3BCLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLG1FQUFtRSxFQUFFO1lBQ3RFLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztZQUVmLElBQU0sQ0FBQyxHQUFHLElBQUksTUFBTSxFQUFFLENBQUM7WUFDdkIsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUVsQixLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztZQUNsQixLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUNqQixLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztZQUVsQixNQUFNLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3RELE1BQU0sQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDdEQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUN6RCxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxpREFBaUQsRUFBRTtZQUNwRCxJQUFNLEtBQUssR0FBRyxRQUFRLENBQUM7WUFFdkIsSUFBTSxDQUFDLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUN2QixNQUFNLENBQUM7Z0JBQ0wsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNwQixDQUFDLENBQUMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNwQixDQUFDLENBQUMsQ0FBQztJQUVMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLFFBQVEsRUFBRTtRQUNqQixVQUFVLENBQUM7WUFDVCxXQUFXLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxrQkFBa0IsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6RixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyw2RUFBNkUsRUFBRTs7Ozs7d0JBQzFFLENBQUMsR0FBRyxJQUFJLE1BQU0sRUFBRSxDQUFDO3dCQUNYLHFCQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQUE7O3dCQUFoQyxHQUFHLEdBQUcsU0FBMEI7d0JBQ3RDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQzs7OzthQUN6QyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsc0VBQXNFLEVBQUU7WUFDekUsSUFBTSxDQUFDLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUV2QixXQUFXLENBQUMsZUFBZSxDQUN6QixPQUFPLENBQUMsT0FBTyxDQUFDO2dCQUNkO29CQUNFLE1BQU0sdUJBQWtCO2lCQUN6QjthQUNGLENBQUMsQ0FDSCxDQUFDO1lBRUYsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUM7Z0JBQ2xELE1BQU0sdUJBQWtCO2FBQ3pCLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDJFQUEyRSxFQUFFOzs7Ozt3QkFDeEUsQ0FBQyxHQUFHLElBQUksTUFBTSxFQUFFLENBQUM7d0JBQ1gscUJBQU0sQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQyxFQUFBOzt3QkFBbkQsR0FBRyxHQUFHLFNBQTZDO3dCQUN6RCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsa0JBQWtCLEVBQUUsa0JBQWtCLENBQUMsQ0FBQyxDQUFDOzs7O2FBQy9ELENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLFVBQVUsRUFBRTtRQUNuQixJQUFNLFNBQVMsR0FBRztZQUNoQixVQUFVLEVBQUUsQ0FBQztZQUNiLFlBQVksRUFBRSxDQUFDO1lBQ2YsS0FBSyxFQUFFO2dCQUNMO29CQUNFLFVBQVUsRUFBRSxDQUFDO29CQUNiLFlBQVksRUFBRSxDQUFDO2lCQUNoQjthQUNGO1NBQ0YsQ0FBQztRQUVGLElBQU0sVUFBVSxHQUFHO1lBQ2pCLFVBQVUsRUFBRSxDQUFDO1lBQ2IsWUFBWSxFQUFFLEVBQUU7WUFDaEIsS0FBSyxFQUFFO2dCQUNMO29CQUNFLFVBQVUsRUFBRSxFQUFFO29CQUNkLFlBQVksRUFBRSxFQUFFO2lCQUNqQjthQUNGO1NBQ0YsQ0FBQztRQUVGLElBQU0sV0FBVyxHQUFHO1lBQ2xCLFVBQVUsRUFBRSxHQUFHO1lBQ2YsWUFBWSxFQUFFLEdBQUc7WUFDakIsS0FBSyxFQUFFO2dCQUNMO29CQUNFLFVBQVUsRUFBRSxHQUFHO29CQUNmLFlBQVksRUFBRSxHQUFHO2lCQUNsQjthQUNGO1NBQ0YsQ0FBQztRQUVGLEVBQUUsQ0FBQyxzQ0FBc0MsRUFBRTs7Ozs7d0JBQ3pDLEtBQUssQ0FBQyxVQUFVLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsVUFBQyxFQUFFLEVBQUUsRUFBRTs0QkFDcEQsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDOzRCQUNkLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQzt3QkFDbEIsQ0FBQyxDQUFDLENBQUM7d0JBRUcsWUFBWSxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQzt3QkFFekIsQ0FBQyxHQUFHLElBQUksTUFBTSxDQUFDOzRCQUNuQixVQUFVLEVBQUUsWUFBWTt5QkFDekIsQ0FBQyxDQUFDO3dCQUVILHFCQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQUE7O3dCQUExQixTQUEwQixDQUFDO3dCQUUzQixNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsb0JBQW9CLENBQUMsV0FBVyxDQUFDLENBQUM7d0JBQ3ZELE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQzs7OzthQUMvQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsOENBQThDLEVBQUU7Ozs7O3dCQUdqRCxXQUFXLENBQUMsa0JBQWtCLENBQUM7NEJBQzdCLE9BQU8sSUFBSSxPQUFPLENBQUMsVUFBQSxPQUFPO2dDQUN4QixVQUFVLENBQUMsY0FBTSxPQUFBLFVBQVUsQ0FBQyxTQUFTLENBQUMsRUFBckIsQ0FBcUIsRUFBRSxDQUFDLENBQUMsQ0FBQztnQ0FDM0MsVUFBVSxDQUFDLGNBQU0sT0FBQSxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQXRCLENBQXNCLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0NBQzVDLFVBQVUsQ0FBQyxjQUFNLE9BQUEsVUFBVSxDQUFDLFdBQVcsQ0FBQyxFQUF2QixDQUF1QixFQUFFLENBQUMsQ0FBQyxDQUFDO2dDQUM3QyxVQUFVLENBQUMsY0FBTSxPQUFBLE9BQU8sQ0FBQyxFQUFFLENBQUMsRUFBWCxDQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0NBRWpDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsQ0FBQzs0QkFDOUIsQ0FBQyxDQUFDLENBQUM7d0JBQ0wsQ0FBQyxDQUFDLENBQUM7d0JBRUgsS0FBSyxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxVQUFDLEVBQUUsRUFBRSxFQUFFOzRCQUNwRCxVQUFVLEdBQUcsRUFBRSxDQUFDO3dCQUNsQixDQUFDLENBQUMsQ0FBQzt3QkFFRyxZQUFZLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO3dCQUV6QixDQUFDLEdBQUcsSUFBSSxNQUFNLENBQUM7NEJBQ25CLGdCQUFnQixFQUFFLENBQUM7NEJBQ25CLFVBQVUsRUFBRSxZQUFZO3lCQUN6QixDQUFDLENBQUM7d0JBRUgscUJBQU0sQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUE7O3dCQUFqQyxTQUFpQyxDQUFDO3dCQUVsQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLENBQUM7d0JBQ3JELE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLENBQUMsQ0FBQzt3QkFDdEQsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxDQUFDOzs7O2FBQ3hELENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyw2RUFBNkUsRUFBRTs7Ozs7d0JBR2hGLFdBQVcsQ0FBQyxrQkFBa0IsQ0FBQzs0QkFDN0IsT0FBTyxJQUFJLE9BQU8sQ0FBQyxVQUFBLE9BQU87Z0NBQ3hCLFVBQVUsQ0FBQyxjQUFNLE9BQUEsVUFBVSxDQUFDLFVBQVUsQ0FBQyxFQUF0QixDQUFzQixFQUFFLENBQUMsQ0FBQyxDQUFDO2dDQUM1QyxVQUFVLENBQUMsY0FBTSxPQUFBLFVBQVUsQ0FBQyxTQUFTLENBQUMsRUFBckIsQ0FBcUIsRUFBRSxDQUFDLENBQUMsQ0FBQztnQ0FDM0MsVUFBVSxDQUFDLGNBQU0sT0FBQSxVQUFVLENBQUMsV0FBVyxDQUFDLEVBQXZCLENBQXVCLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0NBQzdDLFVBQVUsQ0FBQyxjQUFNLE9BQUEsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFYLENBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQztnQ0FFakMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxDQUFDOzRCQUM5QixDQUFDLENBQUMsQ0FBQzt3QkFDTCxDQUFDLENBQUMsQ0FBQzt3QkFFSCxLQUFLLENBQUMsVUFBVSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFVBQUMsRUFBRSxFQUFFLEVBQUU7NEJBQ3BELFVBQVUsR0FBRyxFQUFFLENBQUM7d0JBQ2xCLENBQUMsQ0FBQyxDQUFDO3dCQUVHLFlBQVksR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7d0JBRXpCLENBQUMsR0FBRyxJQUFJLE1BQU0sQ0FBQzs0QkFDbkIsZ0JBQWdCLEVBQUUsQ0FBQzs0QkFDbkIsVUFBVSxFQUFFLFlBQVk7eUJBQ3pCLENBQUMsQ0FBQzt3QkFFSCxxQkFBTSxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBQTs7d0JBQWpDLFNBQWlDLENBQUM7d0JBRWxDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLENBQUMsQ0FBQzt3QkFDdEQsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLG9CQUFvQixDQUFDLFVBQVUsQ0FBQyxDQUFDO3dCQUN0RCxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsb0JBQW9CLENBQUMsV0FBVyxDQUFDLENBQUM7Ozs7YUFDeEQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsImZpbGUiOiJsaWIvYXBpL3VwbG9hZC91cGxvYWQuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgYnkgRmlsZXN0YWNrLlxuICogU29tZSByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IFVwbG9hZCB9IGZyb20gJy4vdXBsb2FkJztcbmltcG9ydCB7IEZpbGVTdGF0ZSB9IGZyb20gJy4vZmlsZSc7XG5pbXBvcnQgeyBTM1VwbG9hZGVyIH0gZnJvbSAnLi91cGxvYWRlcnMvczMnO1xuaW1wb3J0IHsgY29uZmlnIH0gZnJvbSAnLi8uLi8uLi8uLi9jb25maWcnO1xuaW1wb3J0IHsgU3RvcmVVcGxvYWRPcHRpb25zIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBVcGxvYWRNb2RlIH0gZnJvbSAnLi91cGxvYWRlcnMvYWJzdHJhY3QnO1xuXG5jb25zdCB0ZXN0QnVmZmVyID0gQnVmZmVyLmZyb20oJ3Rlc3QgdGVzdCB0ZXN0Jyk7XG5cbmNvbnN0IGN1c3RvbU5hbWVNb2NrZWQgPSBqZXN0LmZuKCk7XG5cbmNvbnN0IG1vY2tlZEZzRmlsZSA9IHt9O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KG1vY2tlZEZzRmlsZSwgJ2N1c3RvbU5hbWUnLCB7XG4gIHNldDogY3VzdG9tTmFtZU1vY2tlZCxcbn0pO1xuXG5qZXN0LnVzZUZha2VUaW1lcnMoKTtcblxuamVzdC5tb2NrKCcuL3VwbG9hZGVycy9zMycpO1xuamVzdC5tb2NrKCcuL2ZpbGVfdG9vbHMnLCAoKSA9PiAoe1xuICBnZXRGaWxlOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IG1vY2tlZEZzRmlsZSksXG59KSk7XG5cbmNvbnN0IG1vY2tlZEZpbGVSZXNwb25zZSA9IHtcbiAgc3RhdHVzOiAnc3RvcmVkJyxcbn07XG5cbmNvbnN0IHNlc3Npb25VUmxzID0gY29uZmlnLnVybHM7XG5jb25zdCBkZWZhdWx0U2Vzc2lvbiA9IHtcbiAgYXBpa2V5OiAndGVzdCcsXG4gIHBvbGljeTogJ3AnLFxuICBzaWduYXR1cmU6ICdzJyxcbiAgdXJsczogc2Vzc2lvblVSbHMsXG59O1xuXG5jb25zdCBtb2NrRXhlY3V0ZSA9IGplc3QuZm4oKTtcblxuZGVzY3JpYmUoJ0FwaS9VcGxvYWQvdXBsb2FkJywgKCkgPT4ge1xuICBiZWZvcmVBbGwoKCkgPT4ge1xuICAgIHNweU9uKFMzVXBsb2FkZXIucHJvdG90eXBlLCAnZXhlY3V0ZScpLmFuZC5jYWxsRmFrZShtb2NrRXhlY3V0ZSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdTZXR0aW5ncycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBjb25zdHJ1Y3RvciBvcHRpb25zJywgKCkgPT4ge1xuICAgICAgY29uc3QgdSA9IG5ldyBVcGxvYWQoe1xuICAgICAgICBwYXJ0U2l6ZTogNSAqIDEwMjQgKiAxMDI0LFxuICAgICAgICBpbnRlbGxpZ2VudENodW5rU2l6ZTogNSAqIDEwMjQgKiAxMDI0LFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChTM1VwbG9hZGVyLnByb3RvdHlwZS5zZXRQYXJ0U2l6ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoNSAqIDEwMjQgKiAxMDI0KTtcbiAgICAgIGV4cGVjdChTM1VwbG9hZGVyLnByb3RvdHlwZS5zZXRJbnRlbGxpZ2VudENodW5rU2l6ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoNSAqIDEwMjQgKiAxMDI0KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgZXJyb3Igb24gd3JvbmcgdXBsb2FkIG9wdGlvbnMnLCAoKSA9PiB7XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBleHBlY3QoKCkgPT4gbmV3IFVwbG9hZCh7IGludGVsbGlnZW50MTogdHJ1ZSB9KSkudG9UaHJvd0Vycm9yKCdJbnZhbGlkIHVwbG9hZCBwYXJhbXMnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgYWNjZXB0IHNhbml0aXplciBzZXR0aW5ncycsICgpID0+IHtcbiAgICAgIGV4cGVjdCgoKSA9PiBuZXcgVXBsb2FkKHt9LCB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgc2FuaXRpemVyOiBmYWxzZSxcbiAgICAgIH0pKS5ub3QudG9UaHJvd0Vycm9yKCdJbnZhbGlkIHVwbG9hZCBwYXJhbXMnKTtcblxuICAgICAgZXhwZWN0KCgpID0+IG5ldyBVcGxvYWQoe30sIHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBzYW5pdGl6ZXI6IHtcbiAgICAgICAgICBleGNsdWRlOiBbJzEnXSxcbiAgICAgICAgICByZXBsYWNlbWVudDogJy0nLFxuICAgICAgICB9LFxuICAgICAgfSkpLm5vdC50b1Rocm93RXJyb3IoJ0ludmFsaWQgdXBsb2FkIHBhcmFtcycpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBlcnJvciBvbiB3cm9uZyBzdG9yZSBvcHRpb25zJywgKCkgPT4ge1xuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgZXhwZWN0KCgpID0+IG5ldyBVcGxvYWQoeyBpbnRlbGxpZ2VudDogdHJ1ZSB9LCB7IHRlc3Q6IDEyMyB9KSkudG9UaHJvd0Vycm9yKCdJbnZhbGlkIHN0b3JlIHVwbG9hZCBwYXJhbXMnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgc2V0IGludGVsbGlnZW50IHVwbG9hZCBtb2RlJywgKCkgPT4ge1xuICAgICAgY29uc3QgdSA9IG5ldyBVcGxvYWQoeyBpbnRlbGxpZ2VudDogdHJ1ZSB9KTtcbiAgICAgIGV4cGVjdChTM1VwbG9hZGVyLnByb3RvdHlwZS5zZXRVcGxvYWRNb2RlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChVcGxvYWRNb2RlLklOVEVMTElHRU5UKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgc2V0IHJlc3BlY3QgZGlzYWJsZUludGVncml0eUNoZWNrIHBhcmFtJywgKCkgPT4ge1xuICAgICAgY29uc3QgdSA9IG5ldyBVcGxvYWQoeyBkaXNhYmxlSW50ZWdyaXR5Q2hlY2s6IHRydWUgfSk7XG4gICAgICBleHBlY3QoUzNVcGxvYWRlci5wcm90b3R5cGUuc2V0SW50ZWdyaXR5Q2hlY2spLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGZhbHNlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZmFsbGJhY2sgdXBsb2FkIG1vZGUnLCAoKSA9PiB7XG4gICAgICBjb25zdCB1ID0gbmV3IFVwbG9hZCh7IGludGVsbGlnZW50OiAnZmFsbGJhY2snIH0pO1xuXG4gICAgICBleHBlY3QoUzNVcGxvYWRlci5wcm90b3R5cGUuc2V0VXBsb2FkTW9kZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoVXBsb2FkTW9kZS5GQUxMQkFDSyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHBhc3Mgc3RvcmUgb3B0aW9ucyB0byB1cGxvYWRlciBjbGFzcycsICgpID0+IHtcbiAgICAgIGNvbnN0IHN0b3JlT3B0aW9uczogU3RvcmVVcGxvYWRPcHRpb25zID0ge1xuICAgICAgICBsb2NhdGlvbjogJ3MzJyxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHUgPSBuZXcgVXBsb2FkKHt9LCBzdG9yZU9wdGlvbnMpO1xuICAgICAgZXhwZWN0KFMzVXBsb2FkZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChzdG9yZU9wdGlvbnMsIHVuZGVmaW5lZCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlc3BlY3QgY29uY3VycmVuY3kgcGFyYW0gaW4gdXBsb2FkIG9wdGlvbnMnLCAoKSA9PiB7XG4gICAgICBjb25zdCB1cGxvYWRPcHRpb25zID0ge1xuICAgICAgICBjb25jdXJyZW5jeTogNCxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHUgPSBuZXcgVXBsb2FkKHVwbG9hZE9wdGlvbnMpO1xuICAgICAgZXhwZWN0KFMzVXBsb2FkZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7fSwgNCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNldCBjb3JyZWN0IHNlY3VyaXR5IHRvIHVwbG9hZGVyJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2VjdXJpdHkgPSB7XG4gICAgICAgIHBvbGljeTogJ3AnLFxuICAgICAgICBzaWduYXR1cmU6ICdzJyxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHUgPSBuZXcgVXBsb2FkKCk7XG4gICAgICB1LnNldFNlY3VyaXR5KHNlY3VyaXR5KTtcblxuICAgICAgZXhwZWN0KFMzVXBsb2FkZXIucHJvdG90eXBlLnNldFNlY3VyaXR5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChzZWN1cml0eSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHBhc3Mgc2Vzc2lvbiB2YXJpYWJsZSB0byB1cGxvYWRlcicsICgpID0+IHtcbiAgICAgIGNvbnN0IHUgPSBuZXcgVXBsb2FkKCk7XG4gICAgICB1LnNldFNlc3Npb24oZGVmYXVsdFNlc3Npb24pO1xuXG4gICAgICBleHBlY3QoUzNVcGxvYWRlci5wcm90b3R5cGUuc2V0VXJsKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChkZWZhdWx0U2Vzc2lvbi51cmxzLnVwbG9hZEFwaVVybCk7XG4gICAgICBleHBlY3QoUzNVcGxvYWRlci5wcm90b3R5cGUuc2V0QXBpa2V5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChkZWZhdWx0U2Vzc2lvbi5hcGlrZXkpO1xuICAgICAgZXhwZWN0KFMzVXBsb2FkZXIucHJvdG90eXBlLnNldFNlY3VyaXR5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IHBvbGljeTogZGVmYXVsdFNlc3Npb24ucG9saWN5LCBzaWduYXR1cmU6IGRlZmF1bHRTZXNzaW9uLnNpZ25hdHVyZSB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgc2V0IHN0b3JlT3B0aW9uIGZpbGVuYW1lIHRvIGNsYXNzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbW9ja0V4ZWN1dGUubW9ja1JldHVyblZhbHVlKFByb21pc2UucmVzb2x2ZShbbW9ja2VkRmlsZVJlc3BvbnNlXSkpO1xuICAgICAgY29uc3QgZmlsZW5hbWVGbiA9ICgpID0+ICd0ZXN0JztcblxuICAgICAgY29uc3QgdSA9IG5ldyBVcGxvYWQoXG4gICAgICAgIHt9LFxuICAgICAgICB7XG4gICAgICAgICAgZmlsZW5hbWU6IGZpbGVuYW1lRm4sXG4gICAgICAgIH1cbiAgICAgICk7XG5cbiAgICAgIGF3YWl0IHUudXBsb2FkKHRlc3RCdWZmZXIpO1xuICAgICAgZXhwZWN0KGN1c3RvbU5hbWVNb2NrZWQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGZpbGVuYW1lRm4pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBhc3NpZ24gbWV0aG9kcyB0byB1c2VyIHByb3ZpZGVkIHRva2VuJywgKCkgPT4ge1xuICAgICAgbGV0IHRva2VuID0ge307XG5cbiAgICAgIGNvbnN0IHUgPSBuZXcgVXBsb2FkKCk7XG4gICAgICB1LnNldFRva2VuKHRva2VuKTtcblxuICAgICAgZXhwZWN0KHRva2VuWydjYW5jZWwnXSkudG9CZVRydXRoeSgpO1xuICAgICAgZXhwZWN0KHRva2VuWydyZXN1bWUnXSkudG9CZVRydXRoeSgpO1xuICAgICAgZXhwZWN0KHRva2VuWydwYXVzZSddKS50b0JlVHJ1dGh5KCk7XG5cbiAgICAgIHRva2VuWydjYW5jZWwnXSgpO1xuICAgICAgdG9rZW5bJ3BhdXNlJ10oKTtcbiAgICAgIHRva2VuWydyZXN1bWUnXSgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBzZXQgdG9rZW4gd2l0aCBtZXRob2RzIHRoYXQgcGF1c2UsY2FuY2VsIG9yIHJlc3VtZSB1cGxvYWRzJywgKCkgPT4ge1xuICAgICAgbGV0IHRva2VuID0ge307XG5cbiAgICAgIGNvbnN0IHUgPSBuZXcgVXBsb2FkKCk7XG4gICAgICB1LnNldFRva2VuKHRva2VuKTtcblxuICAgICAgdG9rZW5bJ2NhbmNlbCddKCk7XG4gICAgICB0b2tlblsncGF1c2UnXSgpO1xuICAgICAgdG9rZW5bJ3Jlc3VtZSddKCk7XG5cbiAgICAgIGV4cGVjdChTM1VwbG9hZGVyLnByb3RvdHlwZS5hYm9ydCkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KFMzVXBsb2FkZXIucHJvdG90eXBlLnBhdXNlKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QoUzNVcGxvYWRlci5wcm90b3R5cGUucmVzdW1lKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IGFuIGVycm9yIGlmIHRva2VuIGlzIG5vdCBhbiBvYmplY3QnLCAoKSA9PiB7XG4gICAgICBjb25zdCB0b2tlbiA9ICcxMjMxMjMnO1xuXG4gICAgICBjb25zdCB1ID0gbmV3IFVwbG9hZCgpO1xuICAgICAgZXhwZWN0KCgpID0+IHtcbiAgICAgICAgdS5zZXRUb2tlbih0b2tlbik7XG4gICAgICB9KS50b1Rocm93RXJyb3IoKTtcbiAgICB9KTtcblxuICB9KTtcblxuICBkZXNjcmliZSgnVXBsb2FkJywgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgbW9ja0V4ZWN1dGUubW9ja1JldHVyblZhbHVlKFByb21pc2UucmVzb2x2ZShbbW9ja2VkRmlsZVJlc3BvbnNlLCBtb2NrZWRGaWxlUmVzcG9uc2VdKSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbm9ybWFsIHVwbG9hZCB3aXRob3V0IGVycm9ycyBhbmQgcmV0dXJuIHNpbmdsZSBmaWxlIHJlc3BvbnNlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdSA9IG5ldyBVcGxvYWQoKTtcbiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHUudXBsb2FkKHRlc3RCdWZmZXIpO1xuICAgICAgZXhwZWN0KHJlcykudG9FcXVhbChtb2NrZWRGaWxlUmVzcG9uc2UpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5vcm1hbCB1cGxvYWQgd2l0aCBlcnJvcnMgYW5kIHJldHVybiByZWplY3RlZCBwcm9taXNlJywgKCkgPT4ge1xuICAgICAgY29uc3QgdSA9IG5ldyBVcGxvYWQoKTtcblxuICAgICAgbW9ja0V4ZWN1dGUubW9ja1JldHVyblZhbHVlKFxuICAgICAgICBQcm9taXNlLnJlc29sdmUoW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIHN0YXR1czogRmlsZVN0YXRlLkZBSUxFRCxcbiAgICAgICAgICB9LFxuICAgICAgICBdKVxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIGV4cGVjdCh1LnVwbG9hZCh0ZXN0QnVmZmVyKSkucmVqZWN0cy50b0VxdWFsKHtcbiAgICAgICAgc3RhdHVzOiBGaWxlU3RhdGUuRkFJTEVELFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgbXVsdGl1cGxvYWQgd2l0aG91dCBlcnJvcnMgYW5kIHJldHVybiBzaW5nbGUgZmlsZSByZXNwb25zZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHUgPSBuZXcgVXBsb2FkKCk7XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCB1Lm11bHRpdXBsb2FkKFt0ZXN0QnVmZmVyLCB0ZXN0QnVmZmVyXSk7XG4gICAgICBleHBlY3QocmVzKS50b0VxdWFsKFttb2NrZWRGaWxlUmVzcG9uc2UsIG1vY2tlZEZpbGVSZXNwb25zZV0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnUHJvZ3Jlc3MnLCAoKSA9PiB7XG4gICAgY29uc3QgcHJvZ3Jlc3MxID0ge1xuICAgICAgdG90YWxCeXRlczogMSxcbiAgICAgIHRvdGFsUGVyY2VudDogMSxcbiAgICAgIGZpbGVzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICB0b3RhbEJ5dGVzOiAxLFxuICAgICAgICAgIHRvdGFsUGVyY2VudDogMSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfTtcblxuICAgIGNvbnN0IHByb2dyZXNzNTAgPSB7XG4gICAgICB0b3RhbEJ5dGVzOiA1LFxuICAgICAgdG90YWxQZXJjZW50OiA1MCxcbiAgICAgIGZpbGVzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICB0b3RhbEJ5dGVzOiA1MCxcbiAgICAgICAgICB0b3RhbFBlcmNlbnQ6IDUwLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9O1xuXG4gICAgY29uc3QgcHJvZ3Jlc3MxMDAgPSB7XG4gICAgICB0b3RhbEJ5dGVzOiAxMDAsXG4gICAgICB0b3RhbFBlcmNlbnQ6IDEwMCxcbiAgICAgIGZpbGVzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICB0b3RhbEJ5dGVzOiAxMDAsXG4gICAgICAgICAgdG90YWxQZXJjZW50OiAxMDAsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH07XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBjb3JyZWN0IHByb2dyZXNzIGV2ZW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgc3B5T24oUzNVcGxvYWRlci5wcm90b3R5cGUsICdvbicpLmFuZC5jYWxsRmFrZSgoZXYsIGNiKSA9PiB7XG4gICAgICAgIGNiKHByb2dyZXNzMSk7XG4gICAgICAgIGNiKHByb2dyZXNzMTAwKTtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBwcm9ncmVzc01vY2sgPSBqZXN0LmZuKCk7XG5cbiAgICAgIGNvbnN0IHUgPSBuZXcgVXBsb2FkKHtcbiAgICAgICAgb25Qcm9ncmVzczogcHJvZ3Jlc3NNb2NrLFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IHUudXBsb2FkKHRlc3RCdWZmZXIpO1xuXG4gICAgICBleHBlY3QocHJvZ3Jlc3NNb2NrKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChwcm9ncmVzczEwMCk7XG4gICAgICBleHBlY3QocHJvZ3Jlc3NNb2NrKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGNhbGwgcHJvZ3Jlc3MgZXZlbnQgb24gZ2l2ZW4gaW50ZXJ2YWwnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgcHJvZ3Jlc3NDYjtcblxuICAgICAgbW9ja0V4ZWN1dGUubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gcHJvZ3Jlc3NDYihwcm9ncmVzczEpLCAxKTtcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHByb2dyZXNzQ2IocHJvZ3Jlc3M1MCksIDIpO1xuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gcHJvZ3Jlc3NDYihwcm9ncmVzczEwMCksIDMpO1xuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gcmVzb2x2ZShbXSksIDQpO1xuXG4gICAgICAgICAgamVzdC5hZHZhbmNlVGltZXJzQnlUaW1lKDQpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBzcHlPbihTM1VwbG9hZGVyLnByb3RvdHlwZSwgJ29uJykuYW5kLmNhbGxGYWtlKChldiwgY2IpID0+IHtcbiAgICAgICAgcHJvZ3Jlc3NDYiA9IGNiO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHByb2dyZXNzTW9jayA9IGplc3QuZm4oKTtcblxuICAgICAgY29uc3QgdSA9IG5ldyBVcGxvYWQoe1xuICAgICAgICBwcm9ncmVzc0ludGVydmFsOiAxLFxuICAgICAgICBvblByb2dyZXNzOiBwcm9ncmVzc01vY2ssXG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgdS5tdWx0aXVwbG9hZChbdGVzdEJ1ZmZlcl0pO1xuXG4gICAgICBleHBlY3QocHJvZ3Jlc3NNb2NrKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChwcm9ncmVzczEpO1xuICAgICAgZXhwZWN0KHByb2dyZXNzTW9jaykudG9IYXZlQmVlbkNhbGxlZFdpdGgocHJvZ3Jlc3M1MCk7XG4gICAgICBleHBlY3QocHJvZ3Jlc3NNb2NrKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChwcm9ncmVzczEwMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHN0YXkgYXQgdGhlIHNhbWUgcHJvZ3Jlc3Mgd2hlbiB1cGxvYWRlciBnb2VzIGJhY2sgd2l0aCBmaWxlIHByb2dyZXNzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHByb2dyZXNzQ2I7XG5cbiAgICAgIG1vY2tFeGVjdXRlLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHByb2dyZXNzQ2IocHJvZ3Jlc3M1MCksIDEpO1xuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gcHJvZ3Jlc3NDYihwcm9ncmVzczEpLCAyKTtcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHByb2dyZXNzQ2IocHJvZ3Jlc3MxMDApLCAzKTtcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHJlc29sdmUoW10pLCA0KTtcblxuICAgICAgICAgIGplc3QuYWR2YW5jZVRpbWVyc0J5VGltZSg0KTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgc3B5T24oUzNVcGxvYWRlci5wcm90b3R5cGUsICdvbicpLmFuZC5jYWxsRmFrZSgoZXYsIGNiKSA9PiB7XG4gICAgICAgIHByb2dyZXNzQ2IgPSBjYjtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBwcm9ncmVzc01vY2sgPSBqZXN0LmZuKCk7XG5cbiAgICAgIGNvbnN0IHUgPSBuZXcgVXBsb2FkKHtcbiAgICAgICAgcHJvZ3Jlc3NJbnRlcnZhbDogMSxcbiAgICAgICAgb25Qcm9ncmVzczogcHJvZ3Jlc3NNb2NrLFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IHUubXVsdGl1cGxvYWQoW3Rlc3RCdWZmZXJdKTtcblxuICAgICAgZXhwZWN0KHByb2dyZXNzTW9jaykudG9IYXZlQmVlbkNhbGxlZFdpdGgocHJvZ3Jlc3M1MCk7XG4gICAgICBleHBlY3QocHJvZ3Jlc3NNb2NrKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChwcm9ncmVzczUwKTtcbiAgICAgIGV4cGVjdChwcm9ncmVzc01vY2spLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHByb2dyZXNzMTAwKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==
